<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AroMi AI ‚Äì Adaptive Wellness Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <style>
    /* Modern CSS with Glassmorphism and animations */
    :root {
      /* Light Theme (Default) */
      --primary: #059669;
      --primary-dark: #047857;
      --bg-gradient: linear-gradient(135deg, #ecfdf5, #f3f4f6, #d1fae5);
      --card-bg: rgba(255, 255, 255, 0.85);
      --card-border: rgba(255, 255, 255, 0.6);
      --text-main: #1f2937;
      --text-muted: #4b5563;
      --danger: #ef4444;
      --warning: #f59e0b;
      --input-bg: white;
      --btn-gray: #e5e7eb;
      --btn-gray-hover: #d1d5db;
    }

    [data-theme="dark"] {
      --primary: #10b981;
      --primary-dark: #059669;
      --bg-gradient: linear-gradient(135deg, #111827, #1f2937, #0f172a);
      --card-bg: rgba(31, 41, 55, 0.85);
      --card-border: rgba(55, 65, 81, 0.6);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --danger: #ef4444;
      --warning: #f59e0b;
      --input-bg: #374151;
      --btn-gray: #374151;
      --btn-gray-hover: #4b5563;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: var(--bg-gradient);
      color: var(--text-main);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Profile Modal Overlay */
    #profileModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(12px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      transition: opacity 0.5s ease;
    }

    .login-box {
      background: var(--card-bg);
      backdrop-filter: blur(16px);
      border: 1px solid var(--card-border);
      padding: 45px;
      border-radius: 24px;
      text-align: center;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
      width: 90%;
      max-width: 420px;
    }

    .login-box h2 {
      color: var(--primary);
      margin-bottom: 20px;
      font-size: 30px;
      font-weight: 800;
    }

    .role-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 16px;
      margin: 15px 0;
      border: none;
      border-radius: 14px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      background: var(--primary);
      color: white;
      transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 10px rgba(5, 150, 105, 0.3);
    }

    .role-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(5, 150, 105, 0.4);
    }

    /* Main App Layout */
    .app-container {
      display: none;
      padding-bottom: 60px;
      animation: fadeInApp 0.6s ease;
    }

    @keyframes fadeInApp {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .navbar {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      padding: 18px 45px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
      border-bottom: 1px solid var(--card-border);
    }

    .navbar h1 {
      color: var(--primary);
      font-size: 26px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .nav-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .api-key-input {
      background: var(--input-bg);
      border: 1px solid var(--card-border);
      padding: 8px 15px;
      border-radius: 20px;
      outline: none;
      font-size: 14px;
      width: 250px;
      color: var(--text-main);
    }

    .api-key-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
    }

    .settings-btn,
    .report-btn {
      padding: 10px 18px;
      border-radius: 20px;
      border: none;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
      transition: 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .settings-btn {
      background: var(--btn-gray);
      color: var(--text-main);
    }

    .settings-btn:hover {
      background: var(--btn-gray-hover);
    }

    .report-btn {
      background: var(--warning);
      color: white;
      display: none;
      box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3);
    }

    .report-btn:hover {
      background: #d97706;
      transform: scale(1.05);
    }

    /* Warning Toast */
    #warningToast {
      position: fixed;
      top: 90px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--danger);
      color: white;
      padding: 16px 30px;
      border-radius: 30px;
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
      z-index: 90;
      display: none;
      animation: slideDown 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    @keyframes slideDown {
      from {
        top: -60px;
        opacity: 0;
      }

      to {
        top: 90px;
        opacity: 1;
      }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px 25px;
    }

    .header-intro {
      text-align: center;
      margin-bottom: 45px;
    }

    .header-intro h2 {
      font-size: 40px;
      font-weight: 800;
      color: var(--text-main);
      margin-bottom: 12px;
      letter-spacing: -0.5px;
    }

    .header-intro p {
      font-size: 18px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .user-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 15px;
      font-weight: bold;
      margin-top: 15px;
      background: var(--btn-gray);
      color: var(--text-main);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    /* Grid Layouts */
    .grid-top {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 25px;
      margin-bottom: 40px;
    }

    .grid-top>.card {
      flex: 0 0 calc(20% - 20px);
      min-width: 200px;
      /* safety for inner content space */
    }

    @media (max-width: 1300px) {
      .grid-top>.card {
        flex: 0 0 calc(33.333% - 17px);
      }
    }

    @media (max-width: 900px) {
      .grid-top>.card {
        flex: 0 0 calc(50% - 12.5px);
      }
    }

    @media (max-width: 600px) {
      .grid-top>.card {
        flex: 0 0 100%;
      }
    }

    .grid-mid {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 25px;
      margin-bottom: 40px;
    }

    .grid-bot {
      display: grid;
      grid-template-columns: 1fr;
      gap: 25px;
      margin-bottom: 40px;
      max-width: 900px;
      margin-inline: auto;
    }

    @media(max-width: 1000px) {
      .grid-mid {
        grid-template-columns: 1fr;
      }
    }

    /* Slides Navigation */
    .slide-nav {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .slide-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 20px;
      background: var(--btn-gray);
      color: var(--text-main);
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .slide-btn.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
    }

    .slide-btn:hover:not(.active) {
      background: #d1d5db;
      transform: translateY(-2px);
    }

    .slide {
      animation: fadeInApp 0.5s ease;
    }

    /* Cards */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      backdrop-filter: blur(16px);
      border-radius: 24px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.04);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s;
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.08);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      color: var(--text-muted);
      font-size: 17px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .card-header i {
      font-size: 24px;
      color: var(--primary);
      background: rgba(5, 150, 105, 0.1);
      padding: 10px;
      border-radius: 12px;
    }

    .card-value {
      font-size: 42px;
      font-weight: 800;
      color: var(--text-main);
      margin-bottom: 8px;
      font-family: 'Inter', sans-serif;
    }

    .card-limit {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 15px;
      font-weight: 500;
    }

    /* Progress Bars */
    .progress-bg {
      background: rgba(0, 0, 0, 0.06);
      height: 12px;
      border-radius: 6px;
      width: 100%;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 6px;
      transition: width 1s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.5s;
      width: 0%;
    }

    .progress-fill.danger {
      background: var(--danger);
    }

    .progress-fill.warning {
      background: var(--warning);
    }

    /* Health Risk & Nutrition */
    .info-panel {
      padding: 20px;
      border-radius: 16px;
      margin-bottom: 20px;
      font-size: 16px;
      line-height: 1.6;
      transition: 0.3s;
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.02);
    }

    .info-panel strong {
      font-size: 18px;
      display: block;
      margin-bottom: 8px;
    }

    .risk-high {
      background: #fee2e2;
      color: #991b1b;
      border-left: 6px solid var(--danger);
    }

    .risk-low {
      background: #d1fae5;
      color: #065f46;
      border-left: 6px solid var(--primary);
    }

    .nutrition-panel {
      background: #fef3c7;
      color: #92400e;
      border-left: 6px solid var(--warning);
    }

    /* Chatbot */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 550px;
      padding: 25px;
    }

    .chat-history {
      flex: 1;
      overflow-y: auto;
      padding-right: 15px;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      scroll-behavior: smooth;
    }

    .chat-history::-webkit-scrollbar {
      width: 6px;
    }

    .chat-history::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }

    .chat-msg {
      max-width: 85%;
      padding: 14px 20px;
      border-radius: 20px;
      font-size: 16px;
      line-height: 1.5;
      animation: fadeInChat 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      word-wrap: break-word;
    }

    .msg-ai {
      background: #f0f9ff;
      color: #0369a1;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      box-shadow: 0 2px 10px rgba(3, 105, 161, 0.05);
    }

    .msg-user {
      background: var(--primary);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      box-shadow: 0 2px 10px rgba(5, 150, 105, 0.2);
    }

    @keyframes fadeInChat {
      from {
        opacity: 0;
        transform: translateY(15px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .chat-input-area {
      display: flex;
      gap: 12px;
      background: var(--input-bg);
      padding: 10px;
      border-radius: 30px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--card-border);
    }

    .chat-input-area input {
      flex: 1;
      padding: 12px 20px;
      border-radius: 25px;
      border: none;
      outline: none;
      transition: 0.3s;
      font-size: 16px;
      background: transparent;
      color: var(--text-main);
    }

    .send-btn {
      background: var(--primary);
      color: white;
      border: none;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .send-btn:hover {
      transform: scale(1.1) rotate(5deg);
      background: var(--primary-dark);
    }

    /* Limits Settings Modal */
    #settingsModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 200;
      display: none;
      justify-content: center;
      align-items: center;
    }

    /* Modals Configuration */
    .settings-box {
      background: var(--card-bg);
      backdrop-filter: blur(16px);
      border: 1px solid var(--card-border);
      padding: 40px;
      border-radius: 24px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
      animation: scaleUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes scaleUp {
      from {
        transform: scale(0.9);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .settings-box h3 {
      margin-bottom: 25px;
      color: var(--text-main);
      font-size: 24px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      font-size: 15px;
      margin-bottom: 8px;
      color: var(--text-muted);
      font-weight: 700;
    }

    .form-group input {
      width: 100%;
      padding: 12px 15px;
      border-radius: 12px;
      border: 2px solid var(--card-border);
      font-size: 16px;
      transition: 0.3s;
      outline: none;
      background: var(--input-bg);
      color: var(--text-main);
    }

    .form-group input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
    }

    .save-btn {
      width: 100%;
      padding: 15px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 800;
      cursor: pointer;
      margin-top: 15px;
      transition: 0.3s;
    }

    .save-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
    }

    /* Send Report Modal */
    #reportModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 200;
      display: none;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>

<body>

  <!-- Login Overlay -->
  <div id="loginOverlay" style="display: flex; justify-content: center; margin-top: 25px;">
    <div class="login-box">
      <h2><i class="fas fa-leaf" style="color:var(--primary);"></i> AroMi AI</h2>
      <p style="margin-bottom: 30px; font-size: 17px; color: var(--text-muted); font-weight:500;">Please select your
        profile to continue</p>
      <button class="role-btn" onclick="selectRole('child')"><i class="fas fa-child"></i> I am a Child</button>
      <button class="role-btn" onclick="selectRole('adult')" style="background: #1e40af;"><i
          class="fas fa-user-circle"></i>
        I am an Adult</button>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" style="display:none; opacity:1;">
    <div class="login-box" style="max-width: 500px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
        <h2 style="margin:0;"><i class="fas fa-leaf" style="color:var(--primary);"></i> Setup Profile</h2>
        <button onclick="toggleProfileModal()"
          style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-muted);"><i
            class="fas fa-times"></i></button>
      </div>

      <div class="form-group">
        <label>Name</label>
        <input type="text" id="prof-name" placeholder="Enter your name" required />
      </div>
      <div class="form-group" style="display: flex; gap: 15px;">
        <div style="flex:1;">
          <label>Age</label>
          <input type="number" id="prof-age" placeholder="Years" required />
        </div>
        <div style="flex:1;">
          <label>Weight (kg)</label>
          <input type="number" id="prof-weight" placeholder="kg" required />
        </div>
        <div style="flex:1;">
          <label>Height (cm)</label>
          <input type="number" id="prof-height" placeholder="cm" required />
        </div>
      </div>
      <div class="form-group" style="text-align: center;">
        <label style="text-align: left;">Profile Picture</label>
        <div
          style="margin: 15px auto; width: 140px; height: 140px; border-radius: 50%; border: 3px solid var(--primary); overflow: hidden; background: var(--btn-gray); display: flex; align-items: center; justify-content: center;">
          <img id="prof-pic-preview" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;" />
          <i id="prof-pic-icon" class="fas fa-camera" style="font-size: 50px; color: var(--text-muted);"></i>
        </div>
        <input type="file" id="prof-pic" accept="image/*"
          style="border: none; padding: 0; box-shadow: none; font-size: 14px;" onchange="previewImage(event)" />
      </div>

      <div style="display: flex; justify-content: center; margin-top: 25px;">
        <button class="role-btn" onclick="submitProfile()"
          style="background: var(--primary); width: auto; padding: 16px 30px;"><i class="fas fa-arrow-right"></i>
          Continue to Dashboard</button>
      </div>
    </div>
  </div>

  <!-- Warning Toast -->
  <div id="warningToast" style="display:none;">
    <i class="fas fa-exclamation-triangle" style="font-size:24px;"></i>
    <span id="warningText"></span>
  </div>

  <!-- App Content -->
  <div class="app-container" id="app">
    <nav class="navbar">
      <h1><i class="fas fa-leaf"></i> AroMi AI</h1>
      <div class="nav-actions">
        <input type="text" id="autoParentEmail" class="api-key-input" placeholder=" Enter ID for Auto Health Alerts..."
          style="display:none;" />
        <button class="settings-btn" onclick="toggleTheme()" id="themeToggleBtn"><i class="fas fa-moon"></i></button>
        <button class="report-btn" id="sendReportBtn" onclick="sendReportToParent()"><i class="fas fa-paper-plane"></i>
          Send to Parent</button>
        <button class="settings-btn" onclick="toggleProfileModal()"><i class="fas fa-user"></i> Profile</button>
        <button class="settings-btn" onclick="toggleSettings()"><i class="fas fa-cog"></i> Limits</button>
      </div>
    </nav>

    <div class="container">
      <div class="header-intro">
        <h2>Adaptive Wellness Command Center</h2>
        <p>Your personalized AI-powered health and nutrition insights</p>
        <div class="user-badge" id="userBadge"><i class="fas fa-user-check"></i> Role: User</div>
      </div>

      <!-- Slide Navigation -->
      <div class="slide-nav">
        <button id="btn-slide1" class="slide-btn active" onclick="showSlide(1)"><i class="fas fa-heartbeat"></i>
          Metrics</button>
        <button id="btn-slide2" class="slide-btn" onclick="showSlide(2)"><i class="fas fa-chart-line"></i> Analysis &
          Plans</button>
        <button id="btn-slide3" class="slide-btn" onclick="showSlide(3)"><i class="fas fa-robot"></i> Chatbot</button>
      </div>

      <!-- Slide 1: Metrics -->
      <div class="slide" id="slide1">
        <!-- Stats Grid -->
        <div class="grid-top">
          <div class="card">
            <div class="card-header"><span>Daily Steps</span><i class="fas fa-shoe-prints"></i></div>
            <div class="card-value" id="val-steps">0</div>
            <div class="card-limit">Goal: <span id="lim-steps">10000</span> steps</div>
            <div class="progress-bg">
              <div class="progress-fill" id="prog-steps"></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><span>Heart Rate</span><i class="fas fa-heartbeat"
                style="color:#e11d48; background: rgba(225,29,72,0.1);"></i></div>
            <div class="card-value" id="val-heart">0 <span style="font-size:18px; color:var(--text-muted);">bpm</span>
            </div>
            <div class="card-limit">Limit: <span id="lim-heart">120</span> bpm (Resting)</div>
            <div class="progress-bg">
              <div class="progress-fill" id="prog-heart" style="background:#e11d48;"></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><span>Calories Burned</span><i class="fas fa-fire"
                style="color:#f97316; background: rgba(249,115,22,0.1);"></i></div>
            <div class="card-value" id="val-calories">0 <span
                style="font-size:18px; color:var(--text-muted);">kcal</span>
            </div>
            <div class="card-limit">Goal: <span id="lim-calories">2000</span> kcal</div>
            <div class="progress-bg">
              <div class="progress-fill" id="prog-calories" style="background:#f97316;"></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><span>Sleep Duration</span><i class="fas fa-bed"
                style="color:#8b5cf6; background: rgba(139,92,246,0.1);"></i></div>
            <div class="card-value" id="val-sleep">0 <span style="font-size:18px; color:var(--text-muted);">h</span>
            </div>
            <div class="card-limit">Goal: <span id="lim-sleep">8</span> hours</div>
            <div class="progress-bg">
              <div class="progress-fill" id="prog-sleep" style="background:#8b5cf6;"></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><span>Body Temp</span><i class="fas fa-thermometer-half"
                style="color:#ef4444; background: rgba(239,68,68,0.1);"></i></div>
            <div class="card-value" id="val-temp">98.6 <span style="font-size:18px; color:var(--text-muted);">¬∞F</span>
            </div>
            <div class="card-limit">Limit: <span id="lim-temp">99.5</span> ¬∞F (Normal)</div>
            <div class="progress-bg">
              <div class="progress-fill" id="prog-temp"></div>
            </div>
          </div>
        </div>
      </div> <!-- End Slide 1 -->

      <!-- Slide 2: Analysis -->
      <div class="slide" id="slide2" style="display:none;">
        <!-- Middle Grid: Charts & AI Insights -->
        <div class="grid-mid">
          <div class="card">
            <div class="card-header"><span>Weekly vs Daily Analysis</span><i class="fas fa-chart-bar"></i></div>
            <div style="position: relative; height:300px; width:100%;">
              <canvas id="analysisChart"></canvas>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><span>Recomandations:Health & Nutrition</span><i class="fas fa-brain"></i></div>
            <div id="riskPanel" class="info-panel risk-low"><strong><i class="fas fa-heartbeat"></i> Health
                Status</strong> Gathering data...</div>
            <div id="nutritionPanel" class="info-panel nutrition-panel"><strong><i class="fas fa-utensils"></i>
                Nutrition
                Plan</strong> Gathering data...</div>
          </div>
        </div>
      </div> <!-- End Slide 2 -->

      <!-- Slide 3: Chatbot -->
      <div class="slide" id="slide3" style="display:none;">
        <!-- Bottom Grid: Chatbot -->
        <div class="grid-bot">
          <div class="card chat-container">
            <div class="card-header"><span>AroMi Health Chatbot</span><i class="fas fa-robot"></i></div>
            <div class="chat-history" id="chatHistoryBox">
              <div class="chat-msg msg-ai">Hi! I am AroMi AI, your Health Assistant..
                <br><br>How can I help you today ?<br>
              </div>
            </div>
            <div class="chat-input-area">
              <input type="text" id="chatInput" placeholder="Ask about your health conditions or warnings..."
                onkeypress="handleKey(event)" autocomplete="off" />
              <button class="send-btn" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
            </div>
          </div>
        </div>
      </div> <!-- End Slide 3 -->

    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal">
    <div class="settings-box">
      <h3><i class="fas fa-sliders-h"></i> Set Daily Limits</h3>
      <div class="form-group">
        <label>Steps Goal</label>
        <input type="number" id="in-steps" value="10000" />
      </div>
      <div class="form-group">
        <label>Calories Goal (kcal)</label>
        <input type="number" id="in-calories" value="2000" />
      </div>
      <div class="form-group">
        <label>Sleep Goal (hours)</label>
        <input type="number" id="in-sleep" value="8" step="0.5" />
      </div>
      <div class="form-group">
        <label>Max Temp Alert (¬∞F)</label>
        <input type="number" id="in-temp" value="99.5" step="0.1" />
      </div>
      <div class="form-group">
        <label>Max Heart Rate Alert (bpm)</label>
        <input type="number" id="in-heart" value="120" />
      </div>
      <button class="save-btn" onclick="saveSettings()">Save Configuration</button>
      <button class="save-btn" onclick="toggleSettings()"
        style="background:#f3f4f6; color:#374151; margin-top:12px; box-shadow:none;">Cancel</button>
    </div>
  </div>

  <!-- Send Report Modal -->
  <div id="reportModal">
    <div class="settings-box">
      <h3><i class="fas fa-paper-plane"></i> Send Report to Parent</h3>
      <p style="margin-bottom: 20px; font-size: 14px; color: var(--text-muted); text-align: left;">Enter an Email or
        Phone number to send your dynamic health metrics.</p>
      <div class="form-group">
        <label>Email or Phone Number</label>
        <input type="text" id="in-contact" placeholder="e.g. parent@email.com or +91345678994" />
      </div>
      <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="save-btn" style="margin-top:0;" onclick="executeSendReport('default')">Default App <i
            class="fas fa-external-link-alt" style="font-size:14px; margin-left:5px;"></i></button>
        <button class="save-btn" style="margin-top:0; background:#ea4335;" onclick="executeSendReport('gmail')">Gmail <i
            class="fab fa-google" style="font-size:14px; margin-left:5px;"></i></button>
      </div>
      <button class="save-btn" onclick="toggleReportModal()"
        style="background:var(--btn-gray); color:var(--text-main); margin-top:12px; box-shadow:none;">Cancel</button>
    </div>
  </div>

  <script>
    // --- Theme Management ---
    function toggleTheme() {
      const isDark = document.body.getAttribute('data-theme') === 'dark';
      if (isDark) {
        document.body.removeAttribute('data-theme');
        document.getElementById('themeToggleBtn').innerHTML = '<i class="fas fa-moon"></i>';
      } else {
        document.body.setAttribute('data-theme', 'dark');
        document.getElementById('themeToggleBtn').innerHTML = '<i class="fas fa-sun"></i>';
      }

      // Force repaint charts to adapt to color context if they exist
      if (myChart) {
        updateCharts();
      }
    }
    function showSlide(slideNum) {
      document.getElementById('slide1').style.display = slideNum === 1 ? 'block' : 'none';
      document.getElementById('slide2').style.display = slideNum === 2 ? 'block' : 'none';
      document.getElementById('slide3').style.display = slideNum === 3 ? 'block' : 'none';

      document.getElementById('btn-slide1').classList.toggle('active', slideNum === 1);
      document.getElementById('btn-slide2').classList.toggle('active', slideNum === 2);
      document.getElementById('btn-slide3').classList.toggle('active', slideNum === 3);
    }

    // --- State Management ---
    let pendingRole = null;
    let currentUserRole = 'adult';
    let userProfile = { name: 'Guest', age: 25, weight: 70, height: 175, pic: null };

    let limits = {
      steps: 10000,
      calories: 2000,
      sleep: 8,
      temp: 99.5,
      heart: 120
    };

    let currentStats = {
      steps: 0, calories: 0, sleep: 0, temp: 98.6, heart: 75
    };

    window.onload = () => {
      // Keep loginOverlay visible, hide other modals
      document.getElementById('profileModal').style.display = 'none';
    };

    function selectRole(role) {
      pendingRole = role;
      document.getElementById('loginOverlay').style.opacity = '0';
      setTimeout(() => {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('profileModal').style.display = 'flex';
      }, 500);
    }

    function previewImage(event) {
      const input = event.target;
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById('prof-pic-preview').src = e.target.result;
          document.getElementById('prof-pic-preview').style.display = 'block';
          document.getElementById('prof-pic-icon').style.display = 'none';
          userProfile.pic = e.target.result; // Temporarily save to profile object
        }
        reader.readAsDataURL(input.files[0]);
      }
    }

    function toggleProfileModal() {
      const modal = document.getElementById('profileModal');
      if (modal.style.display === 'flex') {
        modal.style.display = 'none';
      } else {
        modal.style.display = 'flex';
        // preload current profile data
        document.getElementById('prof-name').value = userProfile.name !== 'Guest' ? userProfile.name : '';
        document.getElementById('prof-age').value = userProfile.age || '';
        document.getElementById('prof-weight').value = userProfile.weight || '';
        document.getElementById('prof-height').value = userProfile.height || '';
        if (userProfile.pic) {
          document.getElementById('prof-pic-preview').src = userProfile.pic;
          document.getElementById('prof-pic-preview').style.display = 'block';
          document.getElementById('prof-pic-icon').style.display = 'none';
        } else {
          document.getElementById('prof-pic-preview').style.display = 'none';
          document.getElementById('prof-pic-icon').style.display = 'block';
        }
      }
    }

    // --- Initialization ---
    function submitProfile() {
      const name = document.getElementById('prof-name').value.trim();
      const age = parseInt(document.getElementById('prof-age').value);
      const weight = parseFloat(document.getElementById('prof-weight').value);
      const height = parseFloat(document.getElementById('prof-height').value);

      if (!name || isNaN(age) || isNaN(weight) || isNaN(height)) {
        alert("Please fill in all profile details correctly.");
        return;
      }

      userProfile = { name, age, weight, height, pic: userProfile.pic };

      // Picture is already read in `previewImage` and stored in `userProfile.pic`.
      // If we directly submit without changing the picture again, just proceed.
      applyProfile(pendingRole);
    }

    function applyProfile(role) {
      // Calculate dynamic limits based on Profile
      // 1. BMI calculation
      let heightInMeters = userProfile.height / 100;
      let bmi = userProfile.weight / (heightInMeters * heightInMeters);

      // 2. Steps limit
      limits.steps = 10000;
      if (userProfile.age < 12) limits.steps = 12000;
      else if (userProfile.age >= 12 && userProfile.age < 18) limits.steps = 11000;
      else if (userProfile.age > 50) limits.steps = 8000;
      if (bmi > 25 && userProfile.age < 50) limits.steps += 1000;

      // 3. Calories (BMR * 1.2 for light activity)
      let bmr = 10 * userProfile.weight + 6.25 * userProfile.height - 5 * userProfile.age + 5;
      limits.calories = Math.max(1200, Math.round(bmr * 1.2));

      // 4. Sleep
      if (userProfile.age < 13) limits.sleep = 10;
      else if (userProfile.age < 18) limits.sleep = 9;
      else if (userProfile.age > 60) limits.sleep = 7.5;
      else limits.sleep = 8;

      // 5. Heart Rate Limit
      let maxHr = 220 - userProfile.age;
      limits.heart = Math.round(maxHr * 0.75);

      // 6. Temp is static
      limits.temp = 99.5;

      // Update Modal inputs for Settings
      document.getElementById('in-steps').value = limits.steps;
      document.getElementById('in-calories').value = limits.calories;
      document.getElementById('in-sleep').value = limits.sleep;
      document.getElementById('in-heart').value = limits.heart;
      document.getElementById('in-temp').value = limits.temp;

      // Update Cards limits directly here, then login() calls updateUI()
      document.getElementById('lim-steps').innerText = limits.steps;
      document.getElementById('lim-calories').innerText = limits.calories;
      document.getElementById('lim-sleep').innerText = limits.sleep;
      document.getElementById('lim-heart').innerText = limits.heart;
      document.getElementById('lim-temp').innerText = limits.temp;

      // We explicitly log in with the parameter passed from submitProfile
      login(role);
    }
    function login(role) {
      currentUserRole = role;
      document.getElementById('profileModal').style.opacity = '0';
      setTimeout(() => {
        document.getElementById('profileModal').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('profileModal').style.opacity = '1'; // reset for later opening manually
      }, 500);

      const badge = document.getElementById('userBadge');
      let imgHtml = userProfile.pic ? `<img src="${userProfile.pic}" style="width:24px; height:24px; border-radius:50%; object-fit:cover; vertical-align:middle; margin-right:4px;" />` : `<i class="fas ${role === 'child' ? 'fa-child' : 'fa-user-circle'}"></i>`;

      if (role === 'child') {
        badge.innerHTML = `${imgHtml} Role: Child Profile - ${userProfile.name} (${userProfile.age}y)`;
        badge.style.background = "#fef08a";
        badge.style.color = "#854d0e";
        document.getElementById('sendReportBtn').style.display = 'inline-flex';
        document.getElementById('autoParentEmail').style.display = 'inline-block';
      } else {
        badge.innerHTML = `${imgHtml} Role: Adult Profile - ${userProfile.name} (${userProfile.age}y)`;
        badge.style.background = "#dbeafe";
        badge.style.color = "#1e40af";
        document.getElementById('sendReportBtn').style.display = 'none';
        document.getElementById('autoParentEmail').style.display = 'inline-block';
      }

      // Force UI updates based on the new limits
      if (currentStats.steps === 0) {
        initApp(); // start simulation if not started
      } else {
        updateUI(); // refresh UI immediately with potentially new limits
      }
    }

    function toggleReportModal() {
      const modal = document.getElementById('reportModal');
      if (modal.style.display === 'flex') {
        modal.style.display = 'none';
      } else {
        modal.style.display = 'flex';
      }
    }

    function sendReportToParent() {
      toggleReportModal();
    }

    function executeSendReport(method = 'default') {
      const contact = document.getElementById('in-contact').value.trim();
      if (!contact) {
        alert("Please enter a valid email or phone number.");
        return;
      }

      const reportBody = `AroMi AI Health Report:\n` +
        `- Steps: ${currentStats.steps} / ${limits.steps}\n` +
        `- Calories: ${currentStats.calories} kcal / ${limits.calories} kcal\n` +
        `- Heart Rate: ${currentStats.heart} bpm\n` +
        `- Body Temp: ${currentStats.temp}¬∞F\n` +
        `- Sleep: ${currentStats.sleep}h / ${limits.sleep}h\n\n` +
        `Check the dashboard for full risk and nutrition plans.`;

      const encodedBody = encodeURIComponent(reportBody);

      if (contact.includes('@')) {
        const subject = encodeURIComponent("AroMi AI Child Health Report");
        if (method === 'gmail') {
          // Open Gmail Compose Window
          window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=${contact}&su=${subject}&body=${encodedBody}`, '_blank');
        } else {
          // Email default client
          window.location.href = `mailto:${contact}?subject=${subject}&body=${encodedBody}`;
        }
      } else {
        // SMS default client (works with most standard systems ?body=)
        if (method === 'gmail') {
          alert('Gmail option is only available for an email address. Defaulting to SMS.');
        }
        window.location.href = `sms:${contact}?body=${encodedBody}`;
      }

      toggleReportModal();

      const btn = document.getElementById('sendReportBtn');
      btn.innerHTML = '<i class="fas fa-check-circle"></i> Sent via App';
      btn.style.background = "var(--primary)";
      setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send to Parent';
        btn.style.background = "var(--warning)";
      }, 4000);
    }

    function toggleSettings() {
      const modal = document.getElementById('settingsModal');
      if (modal.style.display === 'flex') {
        modal.style.display = 'none';
      } else {
        modal.style.display = 'flex';
      }
    }

    function saveSettings() {
      limits.steps = parseFloat(document.getElementById('in-steps').value) || limits.steps;
      limits.calories = parseFloat(document.getElementById('in-calories').value) || limits.calories;
      limits.sleep = parseFloat(document.getElementById('in-sleep').value) || limits.sleep;
      limits.temp = parseFloat(document.getElementById('in-temp').value) || limits.temp;
      limits.heart = parseFloat(document.getElementById('in-heart').value) || limits.heart;

      document.getElementById('lim-steps').innerText = limits.steps;
      document.getElementById('lim-calories').innerText = limits.calories;
      document.getElementById('lim-sleep').innerText = limits.sleep;
      document.getElementById('lim-temp').innerText = limits.temp;
      document.getElementById('lim-heart').innerText = limits.heart;

      toggleSettings();
      updateUI();
      appendChat(`You updated your daily limits! New Goals: Steps (${limits.steps}), Calories (${limits.calories} kcal), Sleep (${limits.sleep}h), Temp Warning (${limits.temp}¬∞F), Heart Rate Alert (${limits.heart} bpm).`, 'ai');
    }

    // --- Dynamic Simulation Update ---
    function initApp() {
      // initial random base
      // if already initialized (stats > 0), don't reset
      if (currentStats.steps === 0) {
        currentStats.steps = Math.floor(Math.random() * 2000) + 1000;
        currentStats.calories = Math.floor(Math.random() * 400) + 200;
        currentStats.sleep = parseFloat((Math.random() * 3 + 5).toFixed(1)); // 5 to 8 hours
        currentStats.temp = parseFloat((Math.random() * 2.5 + 97.2).toFixed(1)); // 97.2 to 99.7
        currentStats.heart = Math.floor(Math.random() * 30) + 65; // 65 to 95 bpm

        initCharts();

        // simulate walking/living over time
        setInterval(() => {
          // Increment trackers organically
          currentStats.steps += Math.floor(Math.random() * 150);
          currentStats.calories += Math.floor(Math.random() * 25);

          // chance to slightly spike temperature
          if (Math.random() > 0.85) {
            currentStats.temp = parseFloat((currentStats.temp + (Math.random() * 0.5 - 0.1)).toFixed(1));
          }

          // fluctuate heart rate
          const hrChange = Math.floor(Math.random() * 15) - 5; // -5 to +10 change
          currentStats.heart = Math.max(60, Math.min(180, currentStats.heart + hrChange));

          updateUI();
          updateCharts();
        }, 8000); // UI updates softly every 8s
      }

      updateUI();
    }

    function updateUI() {
      // Update Header Values
      document.getElementById('val-steps').innerHTML = `${currentStats.steps.toLocaleString()}`;
      document.getElementById('val-heart').innerHTML = `${currentStats.heart} <span style="font-size:18px; color:var(--text-muted);">bpm</span>`;
      document.getElementById('val-calories').innerHTML = `${currentStats.calories} <span style="font-size:18px; color:var(--text-muted);">kcal</span>`;
      document.getElementById('val-sleep').innerHTML = `${currentStats.sleep.toFixed(1)} <span style="font-size:18px; color:var(--text-muted);">h</span>`;
      document.getElementById('val-temp').innerHTML = `${currentStats.temp.toFixed(1)} <span style="font-size:18px; color:var(--text-muted);">¬∞F</span>`;

      // Update Progress Bars
      const pctSteps = Math.min((currentStats.steps / limits.steps) * 100, 100);
      const pctCal = Math.min((currentStats.calories / limits.calories) * 100, 100);
      const pctSleep = Math.min((currentStats.sleep / limits.sleep) * 100, 100);
      const pctHeart = Math.min((currentStats.heart / limits.heart) * 100, 100);

      // temp mapping: 97 is 5%, limits.temp is ~90%
      const minTemp = 97; const maxTempScale = 104;
      let pctTemp = Math.min(Math.max((currentStats.temp - minTemp) / (maxTempScale - minTemp) * 100, 5), 100);

      document.getElementById('prog-steps').style.width = pctSteps + "%";
      document.getElementById('prog-calories').style.width = pctCal + "%";

      const heartBar = document.getElementById('prog-heart');
      heartBar.style.width = pctHeart + "%";

      const sleepBar = document.getElementById('prog-sleep');
      sleepBar.style.width = pctSleep + "%";
      sleepBar.className = (currentStats.sleep < limits.sleep * 0.6) ? "progress-fill warning" : "progress-fill";
      if (currentStats.sleep < limits.sleep * 0.6) sleepBar.style.background = "var(--warning)";
      else sleepBar.style.background = "#8b5cf6";

      const tempBar = document.getElementById('prog-temp');
      tempBar.style.width = pctTemp + "%";

      // Warning System based on Limits
      let warningMessages = [];

      if (currentStats.temp >= limits.temp) {
        tempBar.className = "progress-fill danger";
        tempBar.style.background = "var(--danger)";
        warningMessages.push(`High Body Temperature Detected (${currentStats.temp.toFixed(1)}¬∞F)!`);
      } else if (currentStats.temp > 99.0) {
        tempBar.className = "progress-fill warning";
        tempBar.style.background = "var(--warning)";
      } else {
        tempBar.className = "progress-fill";
        tempBar.style.background = "var(--danger)"; // red base for temp
      }

      if (currentStats.heart >= limits.heart) {
        heartBar.className = "progress-fill danger";
        heartBar.style.background = "var(--danger)";
        warningMessages.push(`Heart Rate exceeds safe limits (${currentStats.heart} bpm)!`);
      } else if (currentStats.heart >= limits.heart * 0.85) {
        heartBar.className = "progress-fill warning";
        heartBar.style.background = "var(--warning)";
      } else {
        heartBar.className = "progress-fill";
        heartBar.style.background = "#e11d48";
      }

      if (warningMessages.length > 0) {
        showWarning(`Urgent Warning: ${warningMessages.join(' ')}`);
      }

      analyzeHealthAndNutrition();
    }

    let warningTimeout;
    let lastAutoSendTime = 0; // Prevent spamming parent email

    function showWarning(msg) {
      const toast = document.getElementById('warningToast');
      if (toast.style.display !== 'flex') {
        document.getElementById('warningText').innerText = msg;
        toast.style.display = 'flex';
        clearTimeout(warningTimeout);
        warningTimeout = setTimeout(() => { toast.style.display = 'none'; }, 8000);
        appendChat(`Health Warning System triggered: ${msg}`, 'ai');

        // Automatically notify via Push if it hasn't sent recently
        const now = Date.now();
        if (now - lastAutoSendTime > 60000) { // Limit to one auto-email per minute minimum
          lastAutoSendTime = now;

          const contact = document.getElementById('autoParentEmail').value.trim();
          if (contact && contact.length > 3) {
            console.log("Auto-triggering push notification due to warning...");
            const subject = "URGENT: AroMi AI Health WARNING";
            const reportBody = `Health Warning: ${msg}`;

            // Use ntfy.sh public push API to send silent push notification to device ID
            const topicId = contact.replace(/[^a-zA-Z0-9_-]/g, "");
            fetch(`https://ntfy.sh/${topicId}`, {
              method: 'POST',
              body: reportBody,
              headers: {
                'Title': subject,
                'Tags': 'warning,rotating_light'
              }
            }).then(() => {
              appendChat(`üö® *Emergency Notification Sent*: Delivered to device ID "${contact}".`, 'ai');
            }).catch(err => {
              console.error("Push delivery failed:", err);
              appendChat(`‚ö†Ô∏è *Network Error*: Failed to send push notification.`, 'ai');
            });
          }
        }
      }
    }

    // --- Intelligence: Disease & Nutrition ---
    function analyzeHealthAndNutrition() {
      let riskText = "";
      let nutritionText = "";
      let isHighRisk = false;

      // Disease Projections based on daily tasks & stats
      let risks = [];
      if (currentStats.temp >= limits.temp) {
        risks.push("<b>Extreme Risk</b>: High possibility of Viral Infection or Fever due to excessive body temperature.");
        isHighRisk = true;
      }
      if (currentStats.heart >= limits.heart) {
        risks.push(`<b>Cardiovascular Risk</b>: Heart rate is critically high (${currentStats.heart} bpm). Stop strenuous activity immediately and seek medical advice if resting.`);
        isHighRisk = true;
      }
      if (currentStats.sleep < limits.sleep - 3) {
        risks.push("<b>High Risk</b>: Severe sleep deprivation detected; increases risk of immunosuppression, hypertension, and cognitive decline.");
        isHighRisk = true;
      } else if (currentStats.sleep < limits.sleep) {
        risks.push("<b>Mild Risk</b>: Fatigue predicted; sleep quota unmet causing low productivity.");
      }

      if (currentStats.steps < limits.steps * 0.25) {
        risks.push("<b>Lifestyle Risk</b>: Highly sedentary behavior. Long term risk of cardiovascular issues and obesity is elevating.");
      }

      if (risks.length === 0) risks.push("Vitals are optimal! Low risk of acute anomalies. Keep maintaining this lifestyle.");

      // Nutrition Plans based on stats/tasks
      if (currentStats.temp >= limits.temp) {
        nutritionText = "üçµ <b>Immune Recovery Plan</b>: Increase fluid intake with warm soups and herbal teas. Consume Vitamin C rich fruits like oranges and kiwi. Avoid oily food.";
      } else if (currentStats.calories > limits.calories * 0.8) {
        nutritionText = "ü•© <b>High Protein Plan</b>: You are burning exceptional calories today! Consume protein-rich foods (lean meat, eggs, beans) to rebuild muscle tissue, and ensure electrolyte hydration.";
      } else if (currentStats.steps < limits.steps * 0.3) {
        nutritionText = "ü•ó <b>Light Diet Plan</b>: Low physical activity detected. Recommend a light diet focusing on fiber (salads, fruits). Avoid heavy carbohydrates and processed foods to prevent lethargy.";
      } else {
        nutritionText = "üçé <b>Balanced Diet Plan</b>: Maintain a standard intake of balanced macros (40% carbs, 30% protein, 30% healthy fats) to sustain your steady routine.";
      }

      const riskPanel = document.getElementById('riskPanel');
      riskPanel.innerHTML = `<strong><i class="fas fa-notes-medical"></i> Health Disease & Risk Assessment</strong> ‚Ä¢ ` + risks.join("<br><br> ‚Ä¢ ");
      riskPanel.className = isHighRisk ? "info-panel risk-high" : "info-panel risk-low";

      const nutPanel = document.getElementById('nutritionPanel');
      nutPanel.innerHTML = `<strong><i class="fas fa-apple-alt"></i> Daily Task Nutrition Plan</strong>${nutritionText}`;
    }

    // --- Charts: Daily & Weekly Analysis ---
    let myChart;
    let weeklyData = [4000, 5200, 3100, 6800, 7500, 4200, 0]; // weekly steps historical
    let dailyTrend = [0, 500, 1200, 2500, 3000, 3600, 0]; // intra-day checkpoints

    function initCharts() {
      const ctx = document.getElementById('analysisChart').getContext('2d');
      weeklyData[6] = currentStats.steps; // Today's steps
      dailyTrend[6] = currentStats.steps;

      myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Today'],
          datasets: [
            {
              type: 'bar',
              label: 'Weekly Analysis (Steps)',
              data: weeklyData,
              backgroundColor: 'rgba(5, 150, 105, 0.6)',
              borderColor: '#059669',
              borderWidth: 1,
              borderRadius: 6
            },
            {
              type: 'line',
              label: 'Daily Analysis Trend (Steps over time)',
              data: dailyTrend,
              borderColor: '#f97316',
              backgroundColor: 'rgba(249, 115, 22, 0.2)',
              borderWidth: 3,
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
            x: { grid: { display: false } }
          },
          plugins: {
            legend: { position: 'top', labels: { font: { family: 'Segoe UI', size: 13, weight: 'bold' } } }
          }
        }
      });
    }

    function updateCharts() {
      if (myChart) {
        myChart.data.datasets[0].data[6] = currentStats.steps;
        myChart.data.datasets[1].data[6] = currentStats.steps;
        myChart.update();
      }
    }

    // --- Chatbot Logic ---
    function handleKey(e) { if (e.key === 'Enter') sendChat(); }

    async function sendChat() {
      const input = document.getElementById('chatInput');
      const msg = input.value.trim();
      if (!msg) return;

      appendChat(msg, 'user');
      input.value = '';

      // Set "typing" indicator
      const typingId = "typing-" + Date.now();
      appendChat("<i>AroMi is thinking...</i>", 'ai', typingId);

      await processLLMApi(msg, typingId);
    }

    function appendChat(text, sender, elementId = null) {
      const box = document.getElementById('chatHistoryBox');
      const div = document.createElement('div');
      div.className = `chat-msg msg-${sender}`;
      if (elementId) div.id = elementId;
      div.innerHTML = text.replace(/\n/g, '<br>');
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    async function processLLMApi(message, typingId) {
      const typingEl = document.getElementById(typingId);

      // Construct system prompt with current user state
      const systemPrompt = `You are AroMi, an empathetic and highly intelligent AI Health & Wellness coach.
You are currently talking to a user with the role of: ${currentUserRole}.
Their profile: Name: ${userProfile.name}, Age: ${userProfile.age}, Weight: ${userProfile.weight}kg, Height: ${userProfile.height}cm.
Here are their LIVE real-time health metrics, against their custom daily limits:
- Body Temperature: ${currentStats.temp.toFixed(1)}¬∞F (Normal limit is ${limits.temp})
- Heart Rate: ${currentStats.heart} bpm (Limit is ${limits.heart})
- Sleep: ${currentStats.sleep.toFixed(1)} hours (Goal is ${limits.sleep}h)
- Activity: ${currentStats.steps} steps so far (Goal is ${limits.steps})
- Calories: ${currentStats.calories} kcal burned (Goal is ${limits.calories})

Use this data to answer their questions. If they ask about their health condition, actively analyze the data above and warn them if temp or heart rate is above limits. Keep your responses concise, friendly, and formatted nicely. Do NOT use markdown code blocks.`;

      try {
        const response = await fetch("http://localhost:5000/api/groq-chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            messages: [
              { role: "system", content: systemPrompt },
              { role: "user", content: message }
            ]
          })
        });

        if (!response.ok) {
          const errData = await response.json().catch(() => ({}));
          throw new Error(`API Error: ${response.status} - ${errData.error || response.statusText}`);
        }

        const data = await response.json();
        const reply = data.choices[0].message.content;

        // Update the typing message with actual text
        typingEl.innerHTML = reply.replace(/\n/g, '<br>');

      } catch (error) {
        console.error("LLM API Error:", error);
        let errorMsg = error.message;
        typingEl.innerHTML = `<b>‚ö†Ô∏è Connection Error:</b> ${errorMsg}`;
        typingEl.style.color = "var(--danger)";
        typingEl.style.background = "#fee2e2";
      }
    }

    // Replaced simulated processAiLogic with processLLMApi above.

  </script>
</body>

</html>
